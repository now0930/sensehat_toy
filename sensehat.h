#include <linux/cdev.h>
#include <linux/workqueue.h>

#define LPS25H (0x5c)	//humidity, temperature
#define LSM9DS1 (0x1c)	//accelometer
#define HTS221 (0x5f)	//humidity, temperature
#define LED_MAX 192
#define LED2472G (0x46)
#define MAX_I2C (32)
#define DeviceName "sensehat_device"


struct hts221 {
	int T0_degC_x8;
	int T1_degC_x8;
	int H0_rH_x2;
	int H1_rH_x2;
	int T0_OUT;
	int T1_OUT;
	int H0_T0_OUT;
	int H1_T0_OUT;
	int T_OUT;
	int H_OUT;
	int T1T0MSB;
	int temperature;
};

struct rpisense {
	struct device *dev;
	struct i2c_client *i2c_client;
	struct hts221 hts221_data;
	struct cdev cdev_temperature;
	struct cdev cdev_humidity;
	char sending_temperature[40];
	char sending_humidity[40];
	char recv_temp_image[LED_MAX];
	char recv_humi_image[LED_MAX];
	struct work_struct temp_queue;
	struct work_struct humi_queue;

	/* Client devices */
};


const char default_image[LED_MAX] ={
	//first row
	//red channel; 0
	0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
	//blue channel; 8
	0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00,
	//green channel; 16
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

	//second row
	//red channel; 24
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//blue channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//green channel;
	0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10,

	//third row
	//red channel; 
	0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00,
	//blue channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//green channel;
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

	//4th row
	//red channel; 
	0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00,
	//blue channel; 
	0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10,
	//green channel;
	0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00,

	//5th row
	//red channel; 
	0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00,
	//blue channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//green channel;
	0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00,

	//6th channel
	//red channel; 
	0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10,
	//blue channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//green channel;
	0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00,

	//7th row
	//red channel; 
	0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10,
	//blue channel; 
	0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00,
	//green channel;
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

	//8th row
	//red channel; 
	0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10,
	//blue channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//green channel;
	0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00,
};
const char no_image[LED_MAX] ={
	//first row
	//red channel; 0
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//blue channel; 8
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//green channel; 16
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

	//second row
	//red channel; 24
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//blue channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//green channel;
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,


	//third row
	//red channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//blue channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//green channel;
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

	//4th row
	//red channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//blue channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//green channel;
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

	//5th row
	//red channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//blue channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//green channel;
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

	//6th channel
	//red channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//blue channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//green channel;
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

	//7th row
	//red channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//blue channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//green channel;
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

	//8th row
	//red channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//blue channel; 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	//green channel;
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};



static int temper_device_open(struct inode *, struct file *);
static int temper_device_release(struct inode *, struct file *);
static ssize_t temperature_read(struct file *, char *, size_t, loff_t *);
static ssize_t temper_ledmat_write(struct file *, const char *, size_t, loff_t *);

static int humidy_device_open(struct inode *, struct file *);
static int humidy_device_release(struct inode *, struct file *);
static ssize_t humidy_read(struct file *, char *, size_t, loff_t *);
static ssize_t humidy_ledmatix_write(struct file *, const char *, size_t, loff_t *);


int get_hts221(struct rpisense *rpisense_ptr);
void flush(struct rpisense *rpisense_ptr, bool flag);
void shift_pixel(bool flag_x, bool flag_y, char* frame_buffer);
static void workfn_display(struct work_struct *work);
static void workfn_display2(struct work_struct *work);
void default_display(struct rpisense *rpisense_ptr);
void clear_display(struct rpisense *rpisense_ptr);
void set_pixel(int x, int y, int red, int green, int blue, char* frame_buffer);
void default_display(struct rpisense *rpisense_ptr);
void setup_hts221(struct rpisense *rpisense_ptr);
void shutdown_hts221(struct rpisense *rpisense_ptr);
static int rpisense_probe(struct i2c_client *i2c,
			       const struct i2c_device_id *id);
static int rpisense_remove(struct i2c_client *i2c);
void flush_temp(struct rpisense *rpisense_ptr);
void flush_humi(struct rpisense *rpisense_ptr);


